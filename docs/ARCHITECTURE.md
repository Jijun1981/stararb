# 期货配对交易系统架构文档

## 1. 系统概述

基于协整理论的金属期货配对交易量化研究平台，采用**4模块线性架构**设计，从数据获取到回测分析的完整量化交易流水线。

### 1.1 设计目标
- **学术严谨性**: 严格按照金融理论实现协整检验和动态对冲
- **工业级质量**: 真实期货交易模拟，包含保证金、滑点、手续费
- **模块化架构**: 清晰的职责分离，便于维护和扩展
- **性能导向**: 满足实时分析和大规模回测需求

### 1.2 核心特性
- 14个金属期货品种全覆盖分析
- Engle-Granger多时间窗口协整检验(1-5年)
- 主筛选条件：5年且1年协整同时满足
- Kalman滤波动态状态估计
- 真实期货交易执行模拟

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────┐    
│  数据管理模块    │    
│                │    
│  • AkShare API │    
│  • Parquet存储  │    
│  • 增量更新     │    
└────────┬────────┘    
         ↓
┌─────────────────┐    
│  协整配对模块    │    
│                │    
│  • EG两步法     │    
│  • 多窗口分析   │    
│  • β参数估计    │    
└────────┬────────┘    
         ↓
┌─────────────────┐    
│  信号生成模块    │    
│                │    
│  • Kalman滤波   │    
│  • 双Z-score   │    
│  • 理论配比     │    
└────────┬────────┘    
         ↓
┌─────────────────┐
│  回测框架模块    │
│                │
│  • 交易执行     │
│  • 风险管理     │
│  • 绩效分析     │
└─────────────────┘
```

### 2.2 数据流向

```
原始价格数据 → 对数价格 → 协整检验 → 配对筛选 → 动态信号 → 交易执行 → 绩效报告
     ↓           ↓          ↓         ↓         ↓          ↓         ↓
  Parquet     多品种     91个配对   64个有效   交易信号    PnL计算   绩效分析
   文件        对齐      多窗口检验   配对      生成       执行      报告
```

## 3. 模块设计

### 3.1 数据管理模块
**职责**: 数据获取、存储、更新、预处理

#### 输入
- AkShare API：14个期货品种0指数连续合约

#### 输出
- 标准化价格数据：DataFrame格式，按日期索引对齐
- 元数据：获取时间、数据起止日期、记录数

#### 关键功能
- **数据获取**: 使用futures_zh_daily_sina接口
- **存储管理**: Parquet格式，支持压缩和增量更新
- **数据预处理**: 对数转换、缺失值填充、异常值检测
- **原子更新**: 临时文件和回滚机制确保数据完整性

### 3.2 协整配对模块
**职责**: 协整检验、配对筛选、方向判定、β参数估计

#### 输入
- 对数价格数据：来自数据管理模块

#### 输出
- 配对参数表：包含多时间窗口p值、β系数、半衰期等
- 有效配对列表：满足5年且1年协整条件的配对

#### 关键功能
- **Engle-Granger检验**: 5个时间窗口(1年、2年、3年、4年、5年)
- **主筛选条件**: 5年p<0.05 且 1年p<0.05
- **方向判定**: 基于最近1年波动率，低波动作X，高波动作Y
- **批量筛选**: 91个可能配对的检验
- **参数估计**: 多窗口β系数和半衰期计算

### 3.3 信号生成模块
**职责**: 基于协整参数生成交易信号

#### 输入
- 配对参数：来自协整配对模块
- 实时价格数据：来自数据管理模块

#### 输出
- 交易信号：开仓、平仓、持有
- 理论手数：基于β系数的配对比例

#### 关键功能
- **Kalman滤波**: 动态β估计和状态更新
- **创新z-score**: 基于Kalman创新序列
- **滚动z-score**: 60日滚动窗口验证
- **信号生成**: |Z|>2开仓，|Z|<0.5平仓
- **手数计算**: 理论配比和整数化处理

### 3.4 回测框架模块
**职责**: 交易执行、风险管理、绩效分析

#### 输入
- 交易信号：来自信号生成模块
- 历史价格数据：来自数据管理模块
- 合约规格：配置文件定义

#### 输出
- 交易记录：每笔交易的详细信息
- PnL曲线：累计收益和每日收益
- 绩效报告：夏普率、最大回撤、胜率等

#### 关键功能
- **交易执行**: 真实期货交易模拟，12%保证金管理
- **费用计算**: 手续费万分之2，滑点3个tick
- **风险控制**: 10%止损线，30天最大持仓
- **绩效分析**: 多维度指标计算和可视化

## 4. 关键技术实现

### 4.1 数据存储架构
```
data/
├── AG0.parquet    # 单品种数据文件
├── AL0.parquet
├── ...
└── metadata.json  # 元数据索引
```

### 4.2 协整检验流程
```python
# 多时间窗口检验
windows = {'1y': 252, '2y': 504, '3y': 756, '4y': 1008, '5y': 1260}
for window_name, days in windows.items():
    # Engle-Granger两步法
    # 第一步：OLS回归 Y = α + βX + ε
    # 第二步：ADF检验残差平稳性
```

### 4.3 信号生成逻辑
```python
# Kalman滤波状态更新
state = [β_t, c_t]  # 二维状态向量
innovation = y_t - (c_t + β_t * x_t)  # 创新序列
z_score = innovation / std(innovation)  # 标准化

# 交易信号
if abs(z_score) > 2.0:
    signal = 'OPEN'
elif abs(z_score) < 0.5:
    signal = 'CLOSE'
```

## 5. 性能优化

### 5.1 计算优化
- **向量化运算**: 使用NumPy/Pandas向量化操作
- **并行处理**: 多配对协整检验并行化
- **缓存机制**: 中间结果缓存减少重复计算

### 5.2 内存管理
- **分批处理**: 大数据集分批加载
- **数据类型优化**: 使用合适的数据类型减少内存占用
- **及时释放**: 不再使用的大对象及时释放

### 5.3 I/O优化
- **Parquet格式**: 列式存储，压缩率高，读取快
- **增量更新**: 只更新新增数据，避免全量重写
- **异步I/O**: 数据读写异步处理

## 6. 扩展性设计

### 6.1 新品种支持
- 配置文件添加品种代码
- 数据获取和存储自动适配
- 协整分析自动包含新品种

### 6.2 策略扩展
- 信号生成模块可替换不同策略
- 支持自定义开平仓逻辑
- 可配置风控参数

### 6.3 数据源扩展
- 数据接口抽象化
- 支持多数据源切换
- 统一数据格式转换

## 7. 部署架构

### 7.1 开发环境
- Python 3.10+
- Jupyter Notebook交互式开发
- Git版本控制

### 7.2 运行环境
- Linux/Windows/MacOS跨平台支持
- 内存需求：4GB+
- 存储需求：10GB+

### 7.3 依赖管理
```yaml
# requirements.txt
pandas>=1.5.0
numpy>=1.23.0
akshare>=1.10.0
statsmodels>=0.13.0
scipy>=1.9.0
pyarrow>=10.0.0
```

## 8. 监控与日志

### 8.1 日志级别
- INFO：正常运行信息
- WARNING：潜在问题警告
- ERROR：错误信息
- DEBUG：调试信息

### 8.2 性能监控
- 模块执行时间统计
- 内存使用监控
- API调用频率控制

### 8.3 异常处理
- 数据异常检测和处理
- API失败重试机制
- 计算异常捕获和恢复

## 9. 版本历史

| 版本 | 日期 | 主要变更 |
|-----|------|---------|
| V2.1 | 2025-08-21 | 删除独立Beta估计模块，功能整合到协整配对模块 |
| V2.0 | 2024-08-19 | 5模块架构设计 |
| V1.0 | 2024-08-01 | 初始版本 |

---
*本文档描述了期货配对交易系统的整体架构设计，详细实现请参考各模块代码和API文档。*